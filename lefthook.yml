# Lefthook - Git hooks manager
# Install: brew install lefthook or cargo install lefthook
# Enable: lefthook install

pre-commit:
  parallel: true
  commands:
    fmt:
      glob: "*.rs"
      run: cargo fmt -- --check
      fail_text: "Code is not formatted. Run 'cargo fmt' to fix."

    clippy:
      glob: "*.rs"
      run: cargo clippy --all-features -- -D warnings
      fail_text: "Clippy warnings found."

    check:
      run: cargo check --all-features
      fail_text: "Compilation errors found."

commit-msg:
  commands:
    commitlint:
      run: |
        # Validate Conventional Commits format
        # Format: type(scope)?: description
        MSG=$(cat {1})
        if ! echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+$"; then
          echo "Commit message does not follow Conventional Commits format."
          echo ""
          echo "Expected format: <type>: <description>"
          echo "Examples:"
          echo "  feat: add new feature"
          echo "  fix: resolve bug"
          echo "  docs: update documentation"
          echo ""
          exit 1
        fi

pre-push:
  parallel: true
  commands:
    doc:
      run: cargo doc --no-deps --all-features --document-private-items
      fail_text: "Documentation build failed. Check for invalid code blocks."

    test:
      # Run tests for changed Rust files
      run: |
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '\.rs$' || true)
        if [ -n "$CHANGED" ]; then
          echo "Testing changed files:"
          echo "$CHANGED"
          # Run all tests if any src/ file changed
          if echo "$CHANGED" | grep -q "^src/"; then
            echo "Running all tests (src/ changed)..."
            cargo test --all-features
          else
            # Run tests for specific test files that changed
            TEST_TARGETS=()
            for file in $CHANGED; do
              if echo "$file" | grep -q "^tests/[^/]*\.rs$"; then
                # Top-level test files (e.g., tests/buffer_tests.rs)
                test_name=$(basename "$file" .rs)
                TEST_TARGETS+=("--test" "$test_name")
              elif echo "$file" | grep -q "^tests/[^/]+/"; then
                # Test directories - run all tests
                echo "Test directory changed, running all tests..."
                cargo test --all-features
                exit 0
              fi
            done
            if [ ${#TEST_TARGETS[@]} -gt 0 ]; then
              echo "Running test targets: ${TEST_TARGETS[*]}"
              cargo test "${TEST_TARGETS[@]}" --all-features
            fi
          fi
        else
          echo "No Rust files changed, skipping tests"
        fi
      fail_text: "Tests failed."

    coverage:
      # Quick coverage check for changed src files (local only)
      run: |
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^src/' || true)
        if [ -n "$CHANGED" ]; then
          echo "ðŸ“Š Running coverage check..."
          # This will fail if any tests fail
          cargo llvm-cov --lib --no-report
        fi
      fail_text: "Coverage check failed. Tests did not pass successfully."
      skip: [ -n "$CI" ]  # Skip in CI, only run locally
