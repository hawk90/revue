# Lefthook - Git hooks manager
# Install: brew install lefthook or cargo install lefthook
# Enable: lefthook install

pre-commit:
  parallel: true
  commands:
    fmt:
      glob: "*.rs"
      run: cargo fmt -- --check
      fail_text: "Code is not formatted. Run 'cargo fmt' to fix."

    clippy:
      glob: "*.rs"
      run: cargo clippy --all-features -- -D warnings
      fail_text: "Clippy warnings found."

    check:
      run: cargo check --all-features
      fail_text: "Compilation errors found."

commit-msg:
  commands:
    commitlint:
      run: |
        # Validate Conventional Commits format
        # Format: type(scope)?: description
        MSG=$(cat {1})
        if ! echo "$MSG" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+$"; then
          echo "Commit message does not follow Conventional Commits format."
          echo ""
          echo "Expected format: <type>: <description>"
          echo "Examples:"
          echo "  feat: add new feature"
          echo "  fix: resolve bug"
          echo "  docs: update documentation"
          echo ""
          exit 1
        fi

pre-push:
  parallel: true
  commands:
    test:
      # Only run tests for changed Rust files
      run: |
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '\.rs$' || true)
        if [ -n "$CHANGED" ]; then
          echo "Testing changed files:"
          echo "$CHANGED"
          # Map test file paths to actual test targets
          TEST_TARGETS=()
          if echo "$CHANGED" | grep -q "^tests/widget/"; then
            TEST_TARGETS+=("--test" "widget_tests")
          fi
          if echo "$CHANGED" | grep -q "^tests/reactive"; then
            TEST_TARGETS+=("--test" "reactive_tests")
          fi
          if echo "$CHANGED" | grep -q "^tests/worker"; then
            TEST_TARGETS+=("--test" "worker_tests")
          fi
          if echo "$CHANGED" | grep -q "^tests/event"; then
            TEST_TARGETS+=("--test" "event_tests")
          fi
          # Other test files
          OTHER_TESTS=$(echo "$CHANGED" | grep "^tests/" | grep -v "^tests/widget/" | grep -v "^tests/reactive" | grep -v "^tests/worker" | grep -v "^tests/event" | sed 's/tests\///' | sed 's/\.rs$//' | sed 's/$/_tests/' | tr '\n' ' ' | tr -s ' ')
          for test in $OTHER_TESTS; do
            TEST_TARGETS+=("--test" "$test")
          done
          if echo "$CHANGED" | grep -q "^src/"; then
            # For src/ changes, run lib tests too
            TEST_TARGETS+=("--lib")
          fi
          if [ ${#TEST_TARGETS[@]} -gt 0 ]; then
            echo "Running test targets: ${TEST_TARGETS[*]}"
            cargo test "${TEST_TARGETS[@]}" --all-features
          fi
        else
          echo "No Rust files changed, skipping tests"
        fi
      fail_text: "Tests failed."

    coverage:
      # Quick coverage check for changed src files (local only)
      run: |
        CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^src/' || true)
        if [ -n "$CHANGED" ]; then
          echo "ðŸ“Š Quick coverage check (no report)..."
          cargo llvm-cov --lib --no-report --ignore-run-fail
        fi
      fail_text: "Coverage check failed."
      skip: [ -n "$CI" ]  # Skip in CI, only run locally
