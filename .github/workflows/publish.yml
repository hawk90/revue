name: Publish

on:
  workflow_call:
  workflow_dispatch:

jobs:
  publish-macros:
    name: Publish revue-macros to crates.io
    runs-on: ubuntu-latest
    environment: crates-io
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check if crate exists
        id: check_crate
        run: |
          if curl -s "https://crates.io/api/v1/crates/revue-macros" | grep -q '"owners"'; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - uses: rust-lang/crates-io-auth-action@v1
        id: auth
        if: steps.check_crate.outputs.exists == 'true'
      - name: Publish revue-macros to crates.io (trusted)
        if: steps.check_crate.outputs.exists == 'true'
        run: |
          cd revue-macros
          cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
      - name: Publish revue-macros to crates.io (first time)
        if: steps.check_crate.outputs.exists == 'false'
        run: |
          cd revue-macros
          cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish:
    name: Publish revue to crates.io
    runs-on: ubuntu-latest
    environment: crates-io
    needs: publish-macros
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: rust-lang/crates-io-auth-action@v1
        id: auth
      - name: Publish to crates.io
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
          REVUE_RELEASE: "1"
