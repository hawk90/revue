name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  pull_request_target:
    types: [opened, edited, synchronize, reopened]
  issues:
    types: [opened]
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings

permissions:
  contents: write
  security-events: write
  pages: write
  id-token: write
  issues: write
  pull-requests: write
  attestations: write

jobs:
  # ═══════════════════════════════════════════════════════════════
  # Stage 1: Lint
  # ═══════════════════════════════════════════════════════════════
  fmt:
    name: Format
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-features -- -D warnings

  commits:
    name: Validate Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v6
        with:
          node-version: "20"
      - name: Install commitlint
        run: |
          npm install --save-dev @commitlint/{cli,config-conventional}
          echo "module.exports = { extends: ['@commitlint/config-conventional'] };" > commitlint.config.js
      - name: Validate PR commits
        if: github.event_name == 'pull_request'
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
      - name: Validate push commit
        if: github.event_name == 'push' && github.event.before != '0000000000000000000000000000000000000000'
        run: npx commitlint --from ${{ github.event.before }} --to ${{ github.event.after }} --verbose

  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    steps:
      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          wip: true
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            PR title must follow Conventional Commits: <type>: <description>

  # ═══════════════════════════════════════════════════════════════
  # Stage 2: Test
  # ═══════════════════════════════════════════════════════════════
  test:
    name: Test (${{ matrix.os }})
    needs: [fmt, clippy]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --all-features

  coverage:
    name: Coverage
    needs: [fmt, clippy]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-llvm-cov
      - run: cargo llvm-cov --all-features --lcov --output-path lcov.info
      - uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: false

  msrv:
    name: MSRV (1.87)
    needs: [fmt, clippy]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@1.87
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --all-features

  # ═══════════════════════════════════════════════════════════════
  # Stage 2: Security
  # ═══════════════════════════════════════════════════════════════
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo generate-lockfile
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6
      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check all

  # ═══════════════════════════════════════════════════════════════
  # Stage 3: Docs (GitHub Pages)
  # ═══════════════════════════════════════════════════════════════
  docs:
    name: Build Docs
    needs: [fmt, clippy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      - name: Build rustdoc
        run: cargo doc --no-deps --all-features --document-private-items
        env:
          RUSTDOCFLAGS: --cfg docsrs -D warnings
      - name: Create index redirect
        run: echo '<html><head><meta http-equiv="refresh" content="0; url=revue/index.html"></head></html>' > target/doc/index.html
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: target/doc

  deploy-docs:
    name: Deploy Docs
    needs: docs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/deploy-pages@v4
        id: deployment

  # ═══════════════════════════════════════════════════════════════
  # Stage 4: Community
  # ═══════════════════════════════════════════════════════════════
  label:
    name: Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  welcome:
    name: Welcome
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' || github.event_name == 'issues'
    steps:
      - uses: actions/first-interaction@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          issue-message: |
            Thanks for opening your first issue! A maintainer will review it soon.
          pr-message: |
            Thanks for your first pull request! A maintainer will review your PR soon.

  stale:
    name: Mark Stale
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/stale@v10
        with:
          stale-issue-message: "This issue has been marked as stale due to inactivity."
          stale-pr-message: "This PR has been marked as stale due to inactivity."
          days-before-stale: 60
          days-before-close: 14
          stale-issue-label: stale
          stale-pr-label: stale
          exempt-issue-labels: "pinned,security,help wanted,good first issue"
          exempt-pr-labels: "pinned,security,work in progress"

  # ═══════════════════════════════════════════════════════════════
  # Stage 5: Release
  # ═══════════════════════════════════════════════════════════════
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: rust

  build:
    name: Build (${{ matrix.target }})
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux glibc
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true
          # Linux musl (static, for Alpine/Nix/etc)
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            cross: true
          # macOS
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-14
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Install musl-tools
        if: contains(matrix.target, 'musl') && !matrix.cross
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Install Cross
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build
        run: ${{ matrix.cross && 'cross' || 'cargo' }} build --release --target ${{ matrix.target }}

      - name: Set binary name
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "BINARY=revue.exe" >> $GITHUB_ENV
          else
            echo "BINARY=revue" >> $GITHUB_ENV
          fi

      - name: Create archive (Unix)
        if: runner.os != 'Windows'
        run: |
          cd target/${{ matrix.target }}/release
          tar -czvf ../../../revue-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.tar.gz ${{ env.BINARY }}
          cp ${{ env.BINARY }} ../../../revue-${{ matrix.target }}

      - name: Create archive (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          7z a ../../../revue-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.zip ${{ env.BINARY }}
          cp ${{ env.BINARY }} ../../../revue-${{ matrix.target }}.exe

      - name: Generate checksums
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            sha256sum revue-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.zip > revue-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.zip.sha256
            sha256sum revue-${{ matrix.target }}.exe > revue-${{ matrix.target }}.exe.sha256
          else
            sha256sum revue-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.tar.gz > revue-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.tar.gz.sha256
            sha256sum revue-${{ matrix.target }} > revue-${{ matrix.target }}.sha256
          fi

      - uses: actions/upload-artifact@v6
        with:
          name: revue-${{ matrix.target }}
          path: |
            revue-${{ needs.release-please.outputs.tag_name }}-${{ matrix.target }}.*
            revue-${{ matrix.target }}*

  upload:
    name: Upload Release
    needs: [release-please, build]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/*

  publish:
    name: Publish
    needs: [release-please, upload]
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo publish
