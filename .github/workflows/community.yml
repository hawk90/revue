name: Community

on:
  pull_request_target:
    types: [opened, edited, synchronize, reopened]
  issues:
    types: [opened]
  schedule:
    - cron: "0 0 * * 1"  # Weekly on Monday
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write
  statuses: write

jobs:
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    steps:
      - uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          wip: true
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            PR title must follow Conventional Commits: <type>: <description>

  label:
    name: Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target'
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  welcome:
    name: Welcome
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' || github.event_name == 'issues'
    steps:
      - uses: actions/first-interaction@v3
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          issue_message: |
            Thanks for opening your first issue! A maintainer will review it soon.
          pr_message: |
            Thanks for your first pull request! A maintainer will review your PR soon.

  stale:
    name: Mark Stale
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/stale@v10
        with:
          stale-issue-message: "This issue has been marked as stale due to inactivity."
          stale-pr-message: "This PR has been marked as stale due to inactivity."
          days-before-stale: 60
          days-before-close: 14
          stale-issue-label: stale
          stale-pr-label: stale
          exempt-issue-labels: "pinned,security,help wanted,good first issue"
          exempt-pr-labels: "pinned,security,work in progress,autorelease: pending"
